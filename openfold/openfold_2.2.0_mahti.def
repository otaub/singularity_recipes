Bootstrap: docker
From: rockylinux/rockylinux:8.10

%post
  cp /usr/bin/true /usr/sbin/useradd
  cp /usr/bin/true /usr/sbin/groupadd

  dnf -y install dnf-plugins-core
  dnf config-manager --set-enabled powertools
  dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
  dnf install -y https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-8.noarch.rpm

  dnf -y upgrade
  dnf -y group install "Development Tools"
  dnf -y install libaio-devel
  dnf -y install wget
  dnf -y install aria2
  dnf -y install libxml2

  # CUDA
  dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo
  dnf -y module install nvidia-driver:560
  dnf -y install cuda-12-6 \
  libcudnn9-cuda-12 libcudnn9-devel-cuda-12 libcusparselt0 \
  libnccl{,-devel,-static}-2.23.4-1+cuda12.6

  dnf clean all
  
  nvidia-smi

  wget -P /opt \
  "https://github.com/conda-forge/miniforge/releases/download/23.3.1-1/Miniforge3-Linux-x86_64.sh" \
  && bash /opt/Miniforge3-Linux-x86_64.sh -b -p /opt/conda \
  && rm /opt/Miniforge3-Linux-x86_64.sh
  
  export PATH=/opt/conda/bin:$PATH

  cd /opt
  git clone https://github.com/aqlaboratory/openfold.git --branch v2.2.0

  mamba env update -n base --file /opt/openfold/environment.yml && mamba clean --all

  wget -q -P /opt/openfold/openfold/resources \
  https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt
  conda run -n base python setup.py install

%environment
  export LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/lib64:$OMPI_DIR/lib64:$LD_LIBRARY_PATH
  export LIBRARY_PATH=  # added 8.1.2025 as modules in host may set this which confuses compilations
  export PATH=$PATH:/root/.local/bin
  export PATH=$PATH:/opt/conda/bin
