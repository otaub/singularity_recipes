Bootstrap: docker
From: rockylinux:9.3

%post
  PYVER=python3.11
  export MAKEFLAGS="-j$(nproc)"

  # Enable powertools
  dnf -y install dnf-plugins-core
  dnf config-manager --set-enabled crb
  dnf -y install epel-release
  dnf -y group install "Development Tools"
  dnf -y install wget
  dnf -y upgrade

  # CUDA
  dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/cuda-rhel9.repo
  dnf -y module enable nvidia-driver:latest-dkms
  dnf -y install cuda-drivers
  dnf -y install cuda-12-4 libnccl libnccl-devel libnccl-static libcudnn9-cuda-12 libcudnn9-devel-cuda-12

  wget -P /opt \
  "https://github.com/conda-forge/miniforge/releases/download/23.3.1-1/Miniforge3-Linux-x86_64.sh" \
  && bash /opt/Miniforge3-Linux-x86_64.sh -b -p /opt/conda \
  && rm /opt/Miniforge3-Linux-x86_64.sh
  
  export PATH=/opt/conda/bin:$PATH

  cd /opt
  git clone https://github.com/bunzela/AIzymes.git

  conda env create -f AIzymes/environment.yml --name AIzymes

  cd /opt
  mkdir rosetta
  cd rosetta
  wget https://downloads.rosettacommons.org/downloads/academic/3.14/rosetta_bin_linux_3.14_bundle.tar.bz2
  tar -xjf rosetta_bin_linux_3.14_bundle.tar.bz2

  cd /opt
  git clone https://github.com/dauparas/LigandMPNN.git
  cd LigandMPNN
  bash get_model_params.sh "./model_params"
  conda run -n AIzymes pip install -r requirements.txt
  
  cd /opt
  git clone https://github.com/dauparas/ProteinMPNN.git
  
  cd /opt
  mkdir /opt/hmmer_build /opt/hmmer
  wget http://eddylab.org/software/hmmer/hmmer-3.4.tar.gz --directory-prefix /opt/hmmer_build
  cd /opt/hmmer_build && tar zxf hmmer-3.4.tar.gz && rm hmmer-3.4.tar.gz
  cd /opt/hmmer_build/hmmer-3.4 && ./configure --prefix /opt/hmmer
  cd /opt/hmmer_build/hmmer-3.4 && make -j8
  cd /opt/hmmer_build/hmmer-3.4 && make install
  cd /opt/hmmer_build/hmmer-3.4/easel && make install
  cd /opt
  rm -R hmmer_build

  cd /opt
  git clone https://github.com/google-deepmind/alphafold3.git
  cd alphafold3
  conda run -n AIzymes pip install -r dev-requirements.txt
  conda run -n AIzymes pip install --no-deps .
  
  conda run -n AIzymes pip install transformers fair-esm
  conda install -n AIzymes conda-forge::ambertools
  

%environment
  export LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/lib64:$OMPI_DIR/lib64:$LD_LIBRARY_PATH
  export LIBRARY_PATH=  # added 8.1.2025 as modules in host may set this which confuses compilations
  export PATH=$PATH:/root/.local/bin
  export PYTHONPATH=$PYTHONPATH:/opt/AIzymes/src/aizymes
