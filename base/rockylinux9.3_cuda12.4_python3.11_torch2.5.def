Bootstrap: docker
From: rockylinux:9.3

%post
  PYVER=python3.11
  export MAKEFLAGS="-j$(nproc)"

  # Enable powertools
  dnf -y install dnf-plugins-core
  dnf config-manager --set-enabled crb
  dnf -y install epel-release
  dnf -y group install "Development Tools"
  dnf -y upgrade
  dnf -y install which wget patch ${PYVER}-devel ${PYVER}-pip git 
  pip3.11 install --upgrade pip
  # Make "python" and "pip" commands work
  alternatives --install /usr/bin/python3 python3 /usr/bin/$PYVER 1
  alternatives --install /usr/bin/python python /usr/bin/python3 1
  alternatives --install /usr/bin/pip3 pip3 /usr/bin/pip3.11 1
  alternatives --install /usr/bin/pip pip /usr/bin/pip3 1

  # CUDA
  dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/cuda-rhel9.repo
  dnf -y module enable nvidia-driver:latest-dkms
  dnf -y module install nvidia-driver:570
  # dnf -y install cuda-drivers
  dnf -y install cuda-12-4 libnccl libnccl-devel libnccl-static libcudnn9-cuda-12 libcudnn9-devel-cuda-12

  pip install wheel
  pip install torch==2.5.1 --extra-index-url https://download.pytorch.org/whl/cu124

  pip cache purge
  dnf clean all

%environment
  export LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/lib64:$OMPI_DIR/lib64:$LD_LIBRARY_PATH
  export LIBRARY_PATH=  # added 8.1.2025 as modules in host may set this which confuses compilations
  export PATH=$PATH:/root/.local/bin
